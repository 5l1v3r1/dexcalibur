<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Dexcalibur - Application topography</title>

    <!-- styles -->
    <!--## pages/inc/tpl_css.html ##-->

    <!--## pages/inc/tpl_js_d3.html ##-->
    <script type="text/javascript" src="../js/d3.geom.js"></script>


    <style type="text/css">

    .apptopo-vtn {
        margin-top: 0px;
        margin-left: 0px;
    }

    #ctn-permissions {
        padding-top:0px
    }

    #ctn-permissions table {
        color: #FFF;
    }

    #ctn-permissions table tbody tr:first td {
        border-top: none;
    }

    #ctn-activities {
        padding:0px;
    }

    #ctn-activities > div.row {
        padding:0px;
    }

    #dataTables-activities thead tr th {
        background-color:#FFF;
    }

    #ctn-manifest div:first {
        padding:5px;
    }

    body {
        background-color:#272822;
    }

    #dataTables-activities {
        margin-top:0px;
    }

    .apptopo-vmenu-disabled {
        color: grey;
        cursor: crosshair;
    } 

    .first-vtn-col {
        border-right: 1px solid #000;
        padding-right: 0px;
        background-color:#272822;
    }

    .apptopo-vmenu {
        padding: 0px;
        margin:0px;
        font-size:1.5em;
        border-right: 1px solid #000;
        color:#FFF;
    }

    .apptopo-vmenu ul {
        padding: 0px;
    }

    .apptopo-vmenu li {
        list-style: none;
        padding-top: 1em;
        padding-bottom: 1em;
        margin: 0px;
        padding-left: 10px;
    }

    .apptopo-vmenu li > span {
        padding-right: 1em;
    }

    .apptopo-vmenu li:hover {
        color: #FFF;
        background-color: #000;
        cursor: pointer;
    }

    .apptopo-vmenu li.active {
        color: #FFF;
        background-color: #000;
    }

    #landing {
        font-size:3em;
        text-align: center;
        color:honeydew;
    }
    </style>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>

<body>

    <div id="wrapper">

        <!-- Navigation -->
        <!--## pages/inc/menu.html ##-->

        <div id="page-wrapper" style="border-width:0px;background-color:#272822;">
            <div class="row" style="background-color:#272822;">
                <div class="col-sm-2 col-lg-2 apptopo-vmenu">
                    <ul>
                        <li id="vmenu-manifest"><span class="fa fa-file"></span>Manifest</li>
                        <li id="vmenu-permissions"><span class="fa fa-key"></span>Permissions&nbsp;&nbsp;<span class="badge badge-success" id="permissions-count"></a></li>
                        <li id="vmenu-overview"><span class="fa fa-folder"></span>Overview</li>
                        <li id="vmenu-activities"><span class="fa fa-folder"></span>Activities&nbsp;&nbsp;<a class="badge badge-success" id="activity-nb">-</a></li>
                        <li id="vmenu-services"><span class="fa fa-folder"></span>Services&nbsp;&nbsp;<a class="badge badge-success" id="service-nb">-</a></li>
                        <li id="vmenu-providers"><span class="fa fa-folder"></span>Providers&nbsp;&nbsp;<a class="badge badge-success" id="provider-nb">-</a></li>
                        <li id="vmenu-receivers"><span class="fa fa-folder"></span>Receivers&nbsp;&nbsp;<a class="badge badge-success" id="receiver-nb">-</a></li>
                        <li id="vmenu-intent"><span class="fa fa-message"></span>Intent&nbsp;&nbsp;</li>
                        <li id="vmenu-tools"><span class="fa fa-wrench"></span>Tools&nbsp;&nbsp;</li>
                    </ul>
                    <!--
                    <div class="panel panel-default panel-appcmp-ppts">
                        <div class="panel-heading">
                                    <b>Permissions</b>
                                    
                                    <a class="badge badge-success" id="permissions-count">-</a>
                                
                        </div>
                        <div class="panel-body table-responsive" style="padding:0px">
                            <table class="table table-sm-3 table-stripped overflow-auto"  style="overflow:scroll">
                                <tbody id="permissions-list">

                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="panel panel-default">
                        <div class="panel-heading">
                            Properties
                        </div>
                        <div class="panel-body">
                            -
                        </div>
                    </div>-->
                </div>

                <div class="col-sm-10 col-lg-10 apptopo-vtn" id="landing"> 
                    <span class="fa fa-arrow-left"></span>&nbsp;Pick an action into the left menu
                </div>

                <div class="col-sm-10 col-lg-10 apptopo-vtn" id="ctn-permissions" style="display:none">
                    <div class="row">
                        <div class="col-lg-6 table-responsive first-vtn-col">
                            <table class="table  table-stripped overflow-auto"  style="overflow:scroll">
                                <tbody id="permissions-list">
    
                                </tbody>
                            </table>      
                        </div>
                        <div class="col-lg-4"></div>
                    </div>
                </div>


                <div class="col-sm-10 col-lg-10 apptopo-vtn" id="ctn-manifest" style="display:none">
                    <div class="row" style="padding:5px">
                        <a class="badge badge-primary" id="ctn-manifest-save"><span class="fa fa-file"></span>&nbsp;save</a>
                        <a class="badge badge-warning" id="ctn-manifest-restore"><span class="fa fa-refresh"></span>&nbsp;restore</a>
                    </div>            
                    <div class="row ctn-manifest-body">
                            <div class="col-lg-12 first-vtn-col"  id="code-manifest"></div>
                    </div>
                </div>


                <div class="col-sm-8 col-lg-8 apptopo-vtn" id="ctn-overview" style="display:none">
                    <div class="row" id="row-cmp-1" style="margin-top:20px"></div>
                </div>


                <div class="col-sm-8 col-lg-8 apptopo-vtn" id="ctn-activities" style="display:none">
                   <div class="row">
                    <div class="col-sm-8 col-lg-8 first-vtn-col">
                        <table width="100%"  class="table table-striped table-bordered table-hover" id="dataTables-activities">
                            <thead>
                                <tr>
                                    <th id="finder-col1" class="col-lg-1">-</th>
                                    <th id="finder-col2" class="col-lg-5">Name</th>
                                    <th id="finder-col3" class="col-lg-3">Tags</th>
                                    <th id="finder-col4" class="col-lg-3">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                
                            </tbody>
                        </table>
                    </div>

                    <div class="col-sm-4 col-lg-4 second-vtn-col"></div>

                    </div>
                <!-- /.col-lg-12 -->
            </div>

            

        </div>
        <!-- /#page-wrapper -->

        <div id="activityModal" class="modal fade" aria-hidden="true" tabindex="-1" role="dialog" >
            <div class="modal-dialog" role="document" style="width:70%">
              <div class="modal-content">
                <div class="modal-header">
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                  <h4 class="modal-title">Activity - <span id="actModName"></span> </h4>
                </div>
                <div class="modal-body">

                    <div class="row">
                        <div class="col-lg-6">
                            <table width="100%" class="table table-striped table-bordered table-hover" id="dataTables-scannerEdit">
                                <tbody>
                                    <tr><td>Implemented by</td><td class="col-lg-8" id="actModImplementedBy"></td></tr>
                                    <tr><td>Tags</td><td class="col-lg-8" id="actModTags"></td></tr>
                                    <tr><td>Intent filter</td><td class="col-lg-8" id="actModIntentFilter"></td></tr>
                                    <tr><td>Intent sent</td><td class="col-lg-8" id="actModIntentSent"></td></tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="col-lg-6">
                            <div class="panel panel-info">
                                <div class="panel-heading">
                                    <div class="row">
                                        <div class="col-lg-8">
                                            Android call signature
                                        </div>
                                        <div class="col-lg-4">
                                            <a class="badge badge-danger">Threat score: 4/5</a>
                                        </div>
                                    </div>
                                </div>
                                <div class="panel-body" style="padding:0px">
                                    <table width="100%" class="table table-striped table-bordered table-hover" style="margin-bottom: 0px" id="actInternalSignatureTable">
                                        <tbody>
                                            <tr><td class="col-lg-8" >DexClassLoader.load</td><td class="col-lg-4 col-threat-score" style="color:orange">3/5</td></tr>
                                            <tr><td class="col-lg-8" >Runtime.exec</td><td class="col-lg-4 col-threat-score" style="color: orangered">5/5</td></tr>
                                        </tbody>
                                    </table>
                                    <div class="row"><div class="col-lg-2 col-lg-offset-5" style="text-align: center">scroll</div></div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
              </div>
            </div>
          </div>
        
          <<div class="modal fade" id="confirmModal" tabindex="-1" role="dialog" aria-labelledby="confirmModalLabel" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title" id="confirm-title">Confirmation</h3>
                        </div>
                        <div class="modal-body" id="confirm-text">
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-danger" id="confirm-btn-abort" data-dismiss="modal">Abort</button>
                            <button type="button" class="btn btn-success confirm" id="confirm-btn-ok">Confirm</button>
                        </div>
                    </div>
                </div>
            </div>
        
    </div>
    <!-- /#wrapper -->

    <!--## pages/inc/tpl_js_end.html ##-->
    <!--## pages/inc/tpl_ace_js.html ##-->

    <!-- Page-Level Demo Scripts - Tables - Use for reference -->

    <script src="/js/wexcalibur.js"></script>
    <script>


    function makeActivityBlock(obj){
        let i= obj.name.lastIndexOf('.');
        let package = (i>-1? DexcaliburAPI.ui.htmlEncode(obj.name.substr(0,i))+"<br>" : '');
        let an = DexcaliburAPI.ui.htmlEncode( i>-1? obj.name.substr(i+1) : obj.name );
        let tags = "";
        if((obj.__tag instanceof Array) && (obj.__tag.length > 0)){
           obj.__tag.map(t => {
                switch(t){
                    case "MAIN":
                        tags += DexcaliburAPI.ui.badge.make('success',t);
                        break;
                    /*case "BROWSABLE":
                        tags += DexcaliburAPI.ui.badge.make('purple',t);
                        break;
                    case "EXPOSED":
                        tags += DexcaliburAPI.ui.badge.make('danger',t);s
                        break;*/
                }
            });
        }
        
        if(tags.length==0){
            tags = "<br>&nbsp;-";
        }

        let body = `

        <div class="col-lg-2">
            <div class="panel panel-appcmp-orange card-activity" activityName="${obj.name}">
                <div class="panel-heading">
                    ${package}
                    <span class="activity-name">${an}</span>
                    ${tags}
                </div>
            </div>
        </div>
        `;

        return body;
    }

    function makeProviderBlock(obj){
        let i= obj.name.lastIndexOf('.');
        let package = (i>-1? DexcaliburAPI.ui.htmlEncode(obj.name.substr(0,i))+"<br>" : '');
        let an = DexcaliburAPI.ui.htmlEncode( i>-1? obj.name.substr(i+1) : obj.name );

        let body = `

        <div class="col-lg-2">
            <div class="panel panel-appcmp-blue card-provider">
                <div class="panel-heading">
                    ${package}
                    <span class="activity-name">${an}</span>
                </div>
            </div>
        </div>
        `;

        return body;
    }

    function makeServiceBlock(obj){
        let i= obj.name.lastIndexOf('.');
        let package = (i>-1? DexcaliburAPI.ui.htmlEncode(obj.name.substr(0,i))+"<br>" : '');
        let an = DexcaliburAPI.ui.htmlEncode( i>-1? obj.name.substr(i+1) : obj.name );

        let body = `

        <div class="col-lg-2">
            <div class="panel panel-appcmp-green card-service">
                <div class="panel-heading">
                    ${package}
                    <span class="activity-name">${an}</span>
                </div>
            </div>
        </div>
        `;

        return body;
    }

    function makeReceiverBlock(obj){
        let i= obj.name.lastIndexOf('.');
        let package = (i>-1? DexcaliburAPI.ui.htmlEncode(obj.name.substr(0,i))+"<br>" : '');
        let an = DexcaliburAPI.ui.htmlEncode( i>-1? obj.name.substr(i+1) : obj.name );

        let body = `

        <div class="col-lg-2">
            <div class="panel panel-appcmp-grey card-receiver">
                <div class="panel-heading">
                    ${package}
                    <span class="activity-name">${an}</span>
                </div>
            </div>
        </div>
        `;

        return body;
    }


    function makeProtectionLevelBadge(type){
        const styles = {
            dangerous: "<a class='badge badge-danger' data-toggle='tooltip' data-placement='bottom' title='dangerous'>!</a>",
            special: "<a class='badge badge-warning' data-toggle='tooltip' data-placement='bottom' title='special'>!</a>",
            signature: "<a class='badge badge-info' data-toggle='tooltip' data-placement='bottom' title='signature'>!</a>",
            normal: "<a class='badge badge-secondary' data-toggle='tooltip' data-placement='bottom' title='normal'><span class='fa fa-info'></span></a>",
        };

        return styles[type];
    }

    function prepareActivityModal(activity){
        //$("#actMod")
        console.log(DexcaliburAPI.search.makeClassLink(activity.__impl));
        $("#actModImplementedBy").html(
            DexcaliburAPI.search.makeClassLink(activity.__impl)
        );
        
        activity.__tag.map(t => {
            $("#actModTags").append(DexcaliburAPI.ui.badge.make('success',t));    
        });

        $("#actModName").html(DexcaliburAPI.ui.htmlEncode(activity.name));
    }

   
    $(document).ready(function() {

        DexcaliburAPI.manifest.getContent({
            200: function(data){

                let d = JSON.parse(data);
                let body = "";
                d = d.data.split("\n");
                d.map(x => {
                    //console.log(x);
                    //if(x[0]=='<') body += "\t";
                    body += DexcaliburAPI.ui.htmlEncode(x)+"\n";
                });

                $("#code-manifest").html(body);
                DexcaliburAPI.editor.newCodeEditor("code-manifest","ace/mode/xml");
                //setupAceEditor("code-manifest");
            }
        });

        $("#ctn-manifest-save").click(x => {

            let data = DexcaliburAPI.editor.getContentOf("code-manifest");
            
            $("#confirm-text").html("Are you sure to save changes ?");
            $("#confirm-btn-ok").click(function(a){
                DexcaliburAPI.manifest.updateContent(data,{
                    200: function(x){
                        alert("Manifest saved");
                    }
                });
            });
            $("#confirmModal").modal();
        });

        DexcaliburAPI.manifest.permissions.list({
            200: function(data){
                

                let body = "";
                let perms = JSON.parse(data);
                let p, n, j;

                for(let i=0; i<perms.data.length; i++){
                    j = perms.data[i].name.lastIndexOf(".");
                    n = perms.data[i].name.substr(j+1);
                    p = perms.data[i].name.substr(0,j);

                    f = " - ";
                    if(perms.data[i].protectionLevel!=null){
                        f = makeProtectionLevelBadge(perms.data[i].protectionLevel);
                    }

                    body += "<tr><td><div class='row'><div class='col-lg-1'>"
                        +f
                        +"</div><div class='col-lg-8'>"
                        +DexcaliburAPI.ui.htmlEncode(p)+"<br>"
                        +DexcaliburAPI.ui.htmlEncode(n)
                        +"</div><div class='col-lg-3' style='font-size:1.5em'>"
                            +"<a  class='badge badge-primary probe' perm=''>probe ON</a>"
                            +"<a  class='badge badge-black' perm=''>info</a>"
                        +"</div></td></tr>";
                }

                $('#permissions-list').html(body);
                $('#permissions-count').html(perms.data.length);
            }
        })

        DexcaliburAPI.manifest.activities.list({
            200: function(data){
                let body = "";
                let act = JSON.parse(data);       

                act.data.map(x=>{
                    $('#row-cmp-1').append(makeActivityBlock(x));
                });
                $('#activity-nb').html(act.data.length);
            }
        });

        DexcaliburAPI.manifest.providers.list({
            200: function(data){
                let body = "";
                let act = JSON.parse(data);       

                act.data.map(x=>{
                //    $('#row-cmp-1').append(makeProviderBlock(x));
                });
                $('#provider-nb').html(act.data.length);
            }
        });

        DexcaliburAPI.manifest.services.list({
            200: function(data){
                let body = "";
                let act = JSON.parse(data);       

                act.data.map(x=>{
                //    $('#row-cmp-1').append(makeServiceBlock(x));
                });
                $('#service-nb').html(act.data.length);
            }
        });

        DexcaliburAPI.manifest.receivers.list({
            200: function(data){
                let body = "";
                let act = JSON.parse(data);       

                act.data.map(x=>{
                //    $('#row-cmp-1').append(makeReceiverBlock(x));
                });
                $('#receiver-nb').html(act.data.length);
            }
        });
        
        $(function () {
            $('[data-toggle="tooltip"]').tooltip()
        });

        $("#row-cmp-1").on('click','.card-activity',function(x){
            DexcaliburAPI.manifest.activities.get(
                x.currentTarget.getAttribute("activityName"), {
                200: function(data){
                    let act = JSON.parse(data);
                    prepareActivityModal(act.data);
                    $('#activityModal').modal();
                }
            });
        });

        // Menu inlighting (active button)
        var ApptoVmenuActive = {
            menu: null,
            ctn: "landing"
        };

        $('.apptopo-vmenu > ul > li').click(x => {
 

            $('#'+ApptoVmenuActive.ctn).css("display","none");
            if(ApptoVmenuActive.menu != null){
                $('#'+ApptoVmenuActive.menu).removeClass("active");
            }

            ApptoVmenuActive.menu = x.currentTarget.attributes.id.nodeValue;
            ApptoVmenuActive.ctn = "ctn-"+ApptoVmenuActive.menu.substr(6);

            $('#'+ApptoVmenuActive.menu).addClass("active");
            $('#'+ApptoVmenuActive.ctn).css('display','block');
            
        });




        let actTable = $('#dataTables-activities').DataTable({
            
            paging:   false,
            ordering: false,
            info:     false,
            searching: false,

            ajax: DexcaliburAPI.manifest.activities.URI.list,
            columns: [
                {
                    "className":      'details-control',
                    "orderable":      false,
                    "data":           null,
                    "defaultContent": ''
                },
                //{   data: 'type'  },
                {   data: 'name'  },
                {  
                    render: function(data, type, row, meta){
                        let body = "";
                        row.__tag.map(x => {
                            switch(x){
                                case "MAIN":
                                    body += DexcaliburAPI.ui.badge.make('success',x);
                                    break;
                            }
                        });

                        return body;
                    }
                },
                { 
                    render: function(data, type, row, meta ){
                        // <button class="btn btn-info runscan" style="height:1.5em;padding-top:0px;padding-bottom:0px;" scanner="`+btoa(row.id)+`">Run</button>
                        return `
                            &nbsp;<button style="height:1.5em;padding-top:0px;padding-bottom:0px;" class="btn btn-success loadscan" scanner="`+btoa(row.id)+`" data-toggle="tooltip" data-placement="bottom" title="Setup the hook set">Deploy</button>
                            &nbsp;<!-- <button style="height:1.5em;padding-top:0px;padding-bottom:0px;" class="btn btn-warning staticscan" scanner="`+btoa(row.id)+`">Static Scan</button> -->`;
                    }
                }
            ],
            responsive: true
        });

        $('#dataTables-scanner tbody').on('click', 'td.details-control', function () {
            var tr = $(this).closest('tr');
            var row = clsTable.row( tr );
            //console.log(row.child);

            if ( row.child.isShown() ) {
                // This row is already open - close it
                row.child.hide();
                tr.removeClass('shown');
            }
            else {
                // Open this row
                row.child( format(row.data()) ).show();
                tr.addClass('shown');
            }
        } );

       $('#dataTables-scanner tbody').on('click', 'a.plgdispl', function () {
            let id = $(this).attr("prologue");
            if( id != null){
                
                let v = $(".plgdispl[prologue="+id+"]").html(); 
                if(v == "show"){
                    $("#"+id).css("display","block");
                    $(".plgdispl[prologue="+id+"]").html("hide");
                }else{
                    $("#"+id).css("display","none");
                    $(".plgdispl[prologue="+id+"]").html("show");
                }
                    
            }else{
                alert('editor not found');
            }
       });
 
        $('#dataTables-scanner tbody').on('click', 'button.runscan', function () {
            let id = $(this).attr("scanner");

            $.ajax("../api/scanner/run",{
                method: "get",
                data: {
                    id: id
                },
                status: {
                    200: function(data,err){
                        //location
                    }
                }
            })
        } );


        $('#dataTables-scanner tbody').on('click', 'button.loadscan', function () {
            let id = $(this).attr("scanner");

            $.ajax("../api/scanner/load",{
                method: "get",
                data: {
                    id: id
                },
                status: {
                    200: function(data,err){
                        location.href="/probe.html";
                    },
                    404: function(data,err){
                        alert("Failed to load bypasser");
                    }
                }
            })
        } );


        //dmTable.ajax.url("../api/device").load();
        $('#dm-refresh-btn').click(()=>{
            clsTable.ajax.reload();
        });
    });

    </script>
</body>

</html>
